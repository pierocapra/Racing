<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Racing</title>
</head>
<body>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <script>
        var carPic = document.createElement("img");
        var carPicLoaded = false;

        var canvas, canvasContext;

        var carRadius = 10;

        var carX = 100;
        var carSpeedX = 5;
        var carY = 100;
        var carSpeedY = 8;

        const TRACK_W = 40;
        const TRACK_H = 40;
        const TRACK_GAP = 2;
        const TRACK_COLS = 20;
        const TRACK_ROWS = 15;
        var trackGrid = [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                         1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,
                         1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
                         1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,
                         1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,
                         1,0,0,1,1,0,0,0,1,1,1,1,0,0,0,0,1,0,0,1,
                         1,0,0,1,1,0,0,0,1,1,1,0,0,0,0,0,1,0,0,1,
                         1,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,1,0,0,1,
                         1,0,0,1,1,0,0,0,0,0,1,0,0,1,0,0,1,0,0,1,
                         1,0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,1,0,0,1,
                         1,0,2,1,0,0,0,1,1,0,0,0,0,1,0,0,0,0,0,1,
                         1,1,1,1,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,1,
                         1,0,0,0,0,0,1,1,1,1,0,0,1,1,0,0,0,0,0,1,
                         1,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,1,1,
                         1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];
        var tracksLeft = 0;

        var mouseX = 0;
        var mouseY = 0;

        const updateMousePos = (event) => {
            var rect = canvas.getBoundingClientRect();
            var root = document.documentElement;

            mouseX = event.clientX - rect.left - root.scrollLeft;
            mouseY = event.clientY - rect.top - root.scrollTop;

            //cheat to test car in any position
            // carX = mouseX;
            // carY = mouseY;
            // carSpeedX = 3;
            // carSpeedY = -4;
        }


        window.onload = () => {
            canvas = document.getElementById('gameCanvas');
            canvasContext = canvas.getContext('2d');

            var framesPerSecond = 30;
            setInterval(updateAll, 1000/framesPerSecond);

            canvas.addEventListener('mousemove', updateMousePos);

            carPic.onload = () => {
                carPicLoaded = true;
            }
            carPic.src = "player1car.png";

            carReset();
        }

        const updateAll = () => {
            moveAll();
            drawAll();            
        }

        const carReset = () => {
            for (let eachRow = 0; eachRow < TRACK_ROWS; eachRow++){
                for (let eachCol = 0; eachCol < TRACK_COLS; eachCol++){

                    var arrayIndex = rowColToArrayIndex(eachCol, eachRow);

                    if(trackGrid[arrayIndex] == 2){
                        trackGrid[arrayIndex] == 0;
                        carX = eachCol * TRACK_W + TRACK_W/2;
                        carY = eachRow * TRACK_H + TRACK_H/2;
                    }
                }
            }        

        }

        const carMove = () => {
            carX += carSpeedX;
            carY += carSpeedY;

            if (carX < 0 && carSpeedX < 0.0) { //left
                carSpeedX = -carSpeedX;
            }
            if (carX > canvas.width && carSpeedX > 0.0) { //right
                carSpeedX = -carSpeedX;
            }
            if ( carY < 0 && carSpeedY < 0.0) { //top
                carSpeedY = -carSpeedY;
            }
            if (carY > canvas.height + carRadius){ //bottom
                carReset();
            }
        }

        const isTrackAtColRow = (col, row) => {
            if (col >= 0 && col < TRACK_COLS &&
                row >= 0 && row < TRACK_ROWS){
                    var trackIndexUnderCoord = rowColToArrayIndex(col, row);
                    return trackGrid[trackIndexUnderCoord] == 1;
                } else {
                    return false;
                }
        }

        const carTrackHandling = () =>{
            var carTrackCol = Math.floor(carX / TRACK_W);
            var carTrackRow = Math.floor(carY / TRACK_H);
            var trackIndexUnderCar = rowColToArrayIndex(carTrackCol, carTrackRow);

            if(carTrackCol >= 0 && 
                carTrackCol < TRACK_COLS &&
                carTrackRow >= 0 &&
                carTrackRow < TRACK_ROWS 
                ) {
                    if (isTrackAtColRow(carTrackCol, carTrackRow)){
                        
                        var prevCarX = carX - carSpeedX;
                        var prevCarY = carY - carSpeedY;
                        var prevTrackCol = Math.floor(prevCarX / TRACK_W);
                        var prevTrackRow = Math.floor(prevCarY / TRACK_H);

                        var bothTestsFailed = true;

                        if (prevTrackCol != carTrackCol){

                            // var adjTrackSide = rowColToArrayIndex(prevTrackCol, carTrackRow);
                            if (isTrackAtColRow(prevTrackCol, carTrackRow)==false){
                                carSpeedX *= -1;
                                bothTestsFailed = false;
                            }
                        }
                        if (prevTrackRow != carTrackRow){
                            // var adjTrackTopBot = rowColToArrayIndex(carTrackCol, prevTrackRow);
                            if (isTrackAtColRow(carTrackCol, prevTrackRow)==false){
                                carSpeedY *= -1;
                                bothTestsFailed = false;
                            }
                        }
                        if (bothTestsFailed){
                            carSpeedX *= -1;
                            carSpeedY *= -1;
                        }
                    }
            }
        }


        const moveAll = () => {

            // carMove();

            carTrackHandling();

        }

        const rowColToArrayIndex = (col, row) => {
            return col + TRACK_COLS * row;
        }

        const drawTracks = () => {
            for (let eachRow = 0; eachRow < TRACK_ROWS; eachRow++){
                for (let eachCol = 0; eachCol < TRACK_COLS; eachCol++){

                    var arrayIndex = rowColToArrayIndex(eachCol, eachRow);

                    if(trackGrid[arrayIndex] == 1){
                        colorRect(TRACK_W* eachCol, TRACK_H  * eachRow , TRACK_W - TRACK_GAP, TRACK_H - TRACK_GAP,'blue');
                    }
                }
            }
        }

        const drawAll = () => {
            colorRect(0, 0, canvas.width,canvas.height,'black');

            // colorCircle(carX, carY, carRadius, 'white');
            if(carPicLoaded) {
                canvasContext.drawImage(carPic, carX -carPic.width/2, carY -carPic.height/2)
            }

            drawTracks();
        }

        const colorRect = (topLeftX, topLeftY, boxWidth, boxHeight,fillColor) => {
            canvasContext.fillStyle = fillColor;
            canvasContext.fillRect(topLeftX,topLeftY,boxWidth,boxHeight);
        }

        const colorCircle = (x, y, radius, fillColor) => {
            canvasContext.fillStyle = fillColor;
            canvasContext.beginPath();
            canvasContext.arc(x, y, radius, 0, Math.PI*2, true);
            canvasContext.fill();
        }
        
        const colorText = (showWords, textX, textY, fillColor) => {
            canvasContext.fillStyle = fillColor;
            canvasContext.fillText(showWords, textX, textY);
        }


    </script>
</body>
</html>